services:
  # ----------------------------------------
  # 1. Prometheus Monitoring Server
  # ----------------------------------------
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./prometheus/alert.rules.yml:/etc/prometheus/alert.rules.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--web.listen-address=:9090'
    restart: always
    
  # ----------------------------------------
  # 2. Alertmanager
  # ----------------------------------------
  alertmanager:
    image: prom/alertmanager:latest
    container_name: alertmanager
    ports:
      - "9093:9093"
    volumes:
      - ./alertmanager/config.yml:/etc/alertmanager/config.yml
      # The Alertmanager data directory is needed for persistence
      - ./alertmanager-data:/alertmanager
    command:
      - '--config.file=/etc/alertmanager/config.yml'
      - '--web.listen-address=:9093'
    restart: always

  # ----------------------------------------
  # 3. Node Exporter (Monitors the host system)
  # ----------------------------------------
  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    ports:
      - "9100:9100"
    # Essential for accessing host metrics
    pid: host
    volumes:
      - /:/host:ro
    command:
      - '--path.rootfs=/host'
    restart: always

  # ----------------------------------------
  # 4. Ansible Webhook Service (Self-Healing Logic)
  #    This service is running the Flask app and Ansible.
  # ----------------------------------------
  ansible-webhook-service:
    # Use the build context where your Dockerfile, webhook.py, and Ansible playbook are located
    build:
      context: ./ansible 
      dockerfile: Dockerfile
    container_name: ansible-webhook-service
    # CRITICAL: Ensure volumes are correctly indented (2 spaces from service name, then 2 spaces for the list items)
    volumes:
  # Mount the Docker socket (this is fine)
      - /var/run/docker.sock:/var/run/docker.sock
      - ./ansible/restart_service.yml:/app/restart_service.yml
      - ./ansible/webhook.py:/app/webhook.py              
    user: root # Run as root to access /var/run/docker.sock (necessary for Docker-in-Docker functionality)
    ports:
      # Expose the Flask port (5000 inside container) to the host (5001 on host for Alertmanager config)
      - "5001:5000"
    environment:
      # Required for Ansible's Docker module to connect to the host's Docker daemon
      - DOCKER_HOST=unix:///var/run/docker.sock
      # Placeholder for Slack notifications (replace with your actual URL)
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL}
    restart: always
